{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://apache.org/burr/spec/scenario.schema.json",
  "title": "Apache Burr golden scenario spec (burr.scenario/v1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "spec_version",
    "scenario_id",
    "graph",
    "initial_state",
    "calls"
  ],
  "properties": {
    "spec_version": {
      "type": "string",
      "const": "burr.scenario/v1"
    },
    "scenario_id": {
      "type": "string",
      "minLength": 1
    },
    "name": {
      "type": "string"
    },
    "description": {
      "type": "string"
    },
    "identifiers": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "app_id": {
          "type": "string",
          "minLength": 1
        },
        "partition_key": {
          "type": "string",
          "minLength": 1
        },
        "sequence_id": {
          "type": [
            "integer",
            "null"
          ],
          "minimum": 0
        }
      }
    },
    "graph": {
      "$ref": "#/$defs/Graph"
    },
    "initial_state": {
      "type": "object"
    },
    "calls": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/Call"
      }
    },
    "tracking": {
      "$ref": "#/$defs/Tracking"
    },
    "persistence": {
      "$ref": "#/$defs/Persistence"
    }
  },
  "$defs": {
    "Graph": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "entrypoint",
        "actions",
        "transitions"
      ],
      "properties": {
        "entrypoint": {
          "type": "string",
          "minLength": 1
        },
        "actions": {
          "type": "object",
          "minProperties": 1,
          "additionalProperties": {
            "$ref": "#/$defs/Action"
          }
        },
        "transitions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Transition"
          }
        }
      }
    },
    "Action": {
      "type": "object",
      "required": [
        "type"
      ],
      "oneOf": [
        {
          "$ref": "#/$defs/ActionNoop"
        },
        {
          "$ref": "#/$defs/ActionSet"
        },
        {
          "$ref": "#/$defs/ActionIncrement"
        },
        {
          "$ref": "#/$defs/ActionAppend"
        },
        {
          "$ref": "#/$defs/ActionFail"
        },
        {
          "$ref": "#/$defs/ActionContextCapture"
        },
        {
          "$ref": "#/$defs/ActionSpanTree"
        },
        {
          "$ref": "#/$defs/ActionStreamChunks"
        }
      ]
    },
    "ActionNoop": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "const": "noop"
        }
      }
    },
    "ActionSet": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "updates"
      ],
      "properties": {
        "type": {
          "const": "set"
        },
        "updates": {
          "type": "object"
        }
      }
    },
    "ActionIncrement": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "field"
      ],
      "properties": {
        "type": {
          "const": "increment"
        },
        "field": {
          "type": "string",
          "minLength": 1
        },
        "by": {
          "type": "number",
          "default": 1
        }
      }
    },
    "ActionAppend": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "field",
        "item"
      ],
      "properties": {
        "type": {
          "const": "append"
        },
        "field": {
          "type": "string",
          "minLength": 1
        },
        "item": {}
      }
    },
    "ActionFail": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "message"
      ],
      "properties": {
        "type": {
          "const": "fail"
        },
        "message": {
          "type": "string"
        },
        "kind": {
          "type": "string"
        }
      }
    },
    "ActionContextCapture": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "into"
      ],
      "properties": {
        "type": {
          "const": "context_capture"
        },
        "into": {
          "type": "string",
          "default": "context"
        },
        "fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ActionSpanTree": {
      "type": "object",
      "additionalProperties": true,
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "const": "span_tree"
        }
      }
    },
    "ActionStreamChunks": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "chunks",
        "into"
      ],
      "properties": {
        "type": {
          "const": "stream_chunks"
        },
        "chunks": {
          "type": "array",
          "items": {}
        },
        "into": {
          "type": "string",
          "default": "chunks"
        }
      }
    },
    "Transition": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "from",
        "to",
        "condition"
      ],
      "properties": {
        "from": {
          "oneOf": [
            {
              "type": "string",
              "minLength": 1
            },
            {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 1
              }
            }
          ]
        },
        "to": {
          "type": "string",
          "minLength": 1
        },
        "condition": {
          "$ref": "#/$defs/Condition"
        }
      }
    },
    "Condition": {
      "type": "object",
      "required": [
        "type"
      ],
      "oneOf": [
        {
          "$ref": "#/$defs/CondDefault"
        },
        {
          "$ref": "#/$defs/CondWhen"
        },
        {
          "$ref": "#/$defs/CondExpr"
        },
        {
          "$ref": "#/$defs/CondAnd"
        },
        {
          "$ref": "#/$defs/CondOr"
        },
        {
          "$ref": "#/$defs/CondNot"
        }
      ]
    },
    "CondDefault": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "const": "default"
        }
      }
    },
    "CondWhen": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "equals"
      ],
      "properties": {
        "type": {
          "const": "when"
        },
        "equals": {
          "type": "object",
          "minProperties": 1
        }
      }
    },
    "CondExpr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "expr"
      ],
      "properties": {
        "type": {
          "const": "expr"
        },
        "expr": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "CondAnd": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "all"
      ],
      "properties": {
        "type": {
          "const": "and"
        },
        "all": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/Condition"
          }
        }
      }
    },
    "CondOr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "any"
      ],
      "properties": {
        "type": {
          "const": "or"
        },
        "any": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/Condition"
          }
        }
      }
    },
    "CondNot": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "cond"
      ],
      "properties": {
        "type": {
          "const": "not"
        },
        "cond": {
          "$ref": "#/$defs/Condition"
        }
      }
    },
    "Call": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "op"
      ],
      "properties": {
        "op": {
          "type": "string",
          "enum": [
            "step",
            "run",
            "iterate",
            "stream_result",
            "astep",
            "arun",
            "aiterate",
            "astream_result"
          ]
        },
        "halt_before": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "halt_after": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "inputs": {
          "type": "object"
        },
        "max_steps": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "Tracking": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "project": {
          "type": "string"
        },
        "storage_dir": {
          "type": "string"
        },
        "capture_files": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "Persistence": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "kind": {
          "type": "string",
          "enum": [
            "sqlite"
          ]
        },
        "db_path": {
          "type": "string"
        }
      }
    }
  }
}
